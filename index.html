<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusCut</title>
    
    <!-- External Libraries & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    
    <!-- Firebase Libraries (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #020617; background-image: url('https://images.unsplash.com/photo-1554141323-945842494587?q=80&w=2594&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; min-height: 100vh; transition: background-image 0.5s ease-in-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.5); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(100, 116, 139, 0.7); }
        .glass-panel { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { position: relative; background-color: rgba(30, 41, 59, 0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.07); transition: all 0.3s; }
        .glass-card:hover { border-color: rgba(99, 102, 241, 0.5) !important; transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .nav-btn { background-color: rgba(51, 65, 85, 0.5); color: #9CA3AF; backdrop-filter: blur(4px); }
        .nav-btn:hover { background-color: rgba(71, 85, 105, 0.7); color: white; }
        .nav-btn.nav-btn-active { background-color: #4f46e5; color: white; }
        .nav-btn.nav-btn-active:hover { background-color: #4338ca; }
        .modal-panel, .side-panel { transition: all 0.3s ease-out; }
        .priority-mendesak { border-left: 4px solid #EF4444 !important; }
        .priority-penting { border-left: 4px solid #F59E0B !important; }
        .priority-biasa { border-left: 4px solid #3B82F6 !important; }
        #focus-bar { z-index: 100; }
        body.comments-open #focus-bar { display: none; }
        .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .profile-pic-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        .card-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; }
        .glass-card:hover .card-actions { opacity: 1; }
        .action-btn { background-color: rgba(15, 23, 42, 0.7); border-radius: 9999px; padding: 6px; line-height: 0; color: #9CA3AF; cursor: pointer; }
        .action-btn:hover { background-color: rgba(51, 65, 85, 1); color: white; }
        .task-column.drag-over { background-color: rgba(99, 102, 241, 0.1); border: 1px dashed rgba(99, 102, 241, 0.5); }
        .task-card.dragging { opacity: 0.5; transform: scale(1.05); box-shadow: 0 20px 30px rgba(0,0,0,0.3); cursor: grabbing; }
        .task-card { cursor: grab; }

        .kanban-scroll-container { position: relative; }
        .kanban-scroll-wrapper { overflow-x: auto; padding-bottom: 1rem; }
        .scroll-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 9999px; width: 40px; height: 40px; display: none; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; z-index: 20; }
        .scroll-btn:hover { background-color: #4f46e5; }
        #scroll-left-btn { left: -20px; }
        #scroll-right-btn { right: -20px; }
        @media (min-width: 1024px) { .scroll-btn { display: flex; } }
    </style>
</head>
<body class="text-white">

    <!-- Login Screen (TIDAK DIUBAH) -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-8 text-center max-w-md w-full">
            <img src="https://i.imgur.com/2z2b0so.jpeg" alt="FocusCut Logo" class="w-24 h-24 rounded-full object-cover mx-auto mb-4 border-2 border-white/20">
            <h1 class="text-3xl font-bold text-white mb-2">FocusCut</h1>
            <p class="text-gray-300 mb-6" data-lang-key="login_prompt">Masuk untuk melanjutkan ke dasbor Anda.</p>
            <div id="login-error-message" class="hidden text-left text-sm bg-red-900/50 text-red-300 p-3 rounded-lg mb-4"></div>
            <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-300">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#4285F4" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#34A853" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l5.657,5.657C40.074,36.938,44,31.016,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FBBC05" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#EA4335" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="none" d="M6,13.5l6,5l6-5L12,2z"></path></svg>
                <span data-lang-key="login_button">Masuk dengan Google</span>
            </button>
            <p class="text-xs text-gray-500 mt-8">FocusCut Version 0.2</p>
        </div>
    </div>

    <!-- Main Application Screen -->
    <div id="app-screen" class="hidden p-4 sm:p-6 lg:p-8 min-h-screen flex-col pb-24">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-white/10">
            <div class="flex items-center gap-4">
                <label for="profile-pic-input" class="cursor-pointer group relative">
                    <img id="profile-pic" src="https://placehold.co/100x100/1e293b/94a3b8?text=User" alt="User Profile" class="w-14 h-14 rounded-full border-2 border-white/20 object-cover group-hover:opacity-60 transition-opacity">
                    <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="ph-bold ph-pencil-simple text-white text-2xl"></i>
                    </div>
                    <div id="profile-pic-loader" class="profile-pic-loader loader hidden"></div>
                </label>
                <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
                <div>
                    <!-- PENAMBAHAN: Tombol edit untuk nama perusahaan -->
                    <div class="flex items-center gap-2">
                         <h1 id="company-name-display" class="text-xl sm:text-2xl font-bold text-white">Nama Perusahaan</h1>
                         <button id="edit-company-btn" class="text-gray-400 hover:text-white" title="Edit Nama Perusahaan"><i class="ph ph-pencil-simple"></i></button>
                    </div>
                    <p id="user-info" class="text-sm text-gray-300 flex items-center gap-2">
                        <span data-lang-key="logged_in_as">Login sebagai:</span>
                        <span id="user-name-display"></span>
                        <button id="edit-profile-btn" class="text-gray-400 hover:text-white" title="Edit Nama Profil"><i class="ph ph-pencil-simple"></i></button>
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-4 mt-4 sm:mt-0 w-full sm:w-auto justify-end">
                <button id="language-switcher-btn" class="bg-slate-700/50 hover:bg-slate-600/50 text-white p-2 rounded-full transition-colors" title="Ganti Bahasa">
                    <span id="language-flag">ðŸ‡®ðŸ‡©</span>
                </button>
                <label for="bg-upload-input" class="cursor-pointer bg-slate-700/50 hover:bg-slate-600/50 text-white p-2 rounded-full transition-colors" data-lang-title="change_bg_title"><i class="ph-bold ph-image"></i></label>
                <input type="file" id="bg-upload-input" class="hidden" accept="image/*">
                <div id="presence-indicators" class="flex items-center -space-x-2"></div>
                <button id="logout-btn" class="bg-red-600/80 hover:bg-red-700/80 text-white p-2 rounded-full transition-colors" data-lang-title="logout_title"><i class="ph-bold ph-sign-out"></i></button>
                <div id="main-actions">
                    <button id="add-task-btn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300"><i class="ph-bold ph-plus-circle text-xl"></i><span data-lang-key="add_project_btn">Tambah Proyek</span></button>
                    <button id="add-asset-btn" class="hidden items-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300"><i class="ph-bold ph-archive text-xl"></i><span data-lang-key="add_asset_btn">Tambah Aset</span></button>
                </div>
            </div>
        </header>

        <nav class="flex space-x-2 mb-6 overflow-x-auto custom-scrollbar pb-2">
            <button id="nav-kanban" data-view="kanban-view" class="nav-btn font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex-shrink-0"><i class="ph-fill ph-columns mr-1"></i> <span data-lang-key="nav_kanban">Papan Proyek</span></button>
            <button id="nav-assets" data-view="assets-view" class="nav-btn font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex-shrink-0"><i class="ph-fill ph-database mr-1"></i> <span data-lang-key="nav_assets">Bank Konten</span></button>
            <button id="nav-invoice" data-view="invoice-view" class="nav-btn font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex-shrink-0"><i class="ph-fill ph-receipt mr-1"></i> <span data-lang-key="nav_invoice">Invoice</span></button>
            <button id="nav-analytics" data-view="analytics-view" class="nav-btn font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex-shrink-0"><i class="ph-fill ph-chart-bar mr-1"></i> <span data-lang-key="nav_analytics">Analitik</span></button>
        </nav>

        <div class="flex-grow flex flex-col">
            <main id="kanban-view" class="main-view flex flex-col flex-grow">
                 <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="relative flex-grow"><input type="text" id="task-search-input" data-lang-placeholder="search_placeholder" class="w-full bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none"><i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                    <div class="relative"><select id="task-sort-select" class="w-full md:w-auto appearance-none bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-lg pl-4 pr-10 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="date_desc" data-lang-key="sort_date_desc">Urutkan: Tanggal (Terbaru)</option>
                        <option value="date_asc" data-lang-key="sort_date_asc">Urutkan: Tanggal (Terlama)</option>
                        <option value="name_az" data-lang-key="sort_name_az">Urutkan: Nama Klien (A-Z)</option>
                        <option value="name_za" data-lang-key="sort_name_za">Urutkan: Nama Klien (Z-A)</option>
                    </select><i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div>
                </div>
                <div class="flex-grow kanban-scroll-container">
                    <button id="scroll-left-btn" class="scroll-btn"><i class="ph-bold ph-caret-left text-2xl"></i></button>
                    <div id="kanban-scroll-wrapper" class="kanban-scroll-wrapper custom-scrollbar">
                        <div id="kanban-board" class="flex flex-row gap-6 pb-4 min-w-max">
                            <div class="glass-panel rounded-xl p-4 flex flex-col w-80 sm:w-96 flex-shrink-0"><h2 class="text-lg font-semibold mb-4 flex justify-between items-center text-cyan-300"><span><i class="ph-fill ph-list-bullets mr-2"></i><span data-lang-key="kanban_todo">List Konten</span></span><span id="todo-count" class="bg-cyan-800 text-cyan-200 text-xs font-bold px-2 py-1 rounded-full">0</span></h2><div id="todo-column" class="task-column flex-grow overflow-y-auto custom-scrollbar pr-1 min-h-[200px]" data-status="todo"></div></div>
                            <div class="glass-panel rounded-xl p-4 flex flex-col w-80 sm:w-96 flex-shrink-0"><h2 class="text-lg font-semibold mb-4 flex justify-between items-center text-amber-300"><span><i class="ph-fill ph-person-simple-run mr-2"></i><span data-lang-key="kanban_wip">Proses Editing</span></span><span id="wip-count" class="bg-amber-800 text-amber-200 text-xs font-bold px-2 py-1 rounded-full">0</span></h2><div id="wip-column" class="task-column flex-grow overflow-y-auto custom-scrollbar pr-1 min-h-[200px]" data-status="wip"></div></div>
                            <div class="glass-panel rounded-xl p-4 flex flex-col w-80 sm:w-96 flex-shrink-0"><h2 class="text-lg font-semibold mb-4 flex justify-between items-center text-purple-300"><span><i class="ph-fill ph-eye mr-2"></i><span data-lang-key="kanban_review">Review / Revisi</span></span><span id="review-count" class="bg-purple-800 text-purple-200 text-xs font-bold px-2 py-1 rounded-full">0</span></h2><div id="review-column" class="task-column flex-grow overflow-y-auto custom-scrollbar pr-1 min-h-[200px]" data-status="review"></div></div>
                            <div class="glass-panel rounded-xl p-4 flex flex-col w-80 sm:w-96 flex-shrink-0"><h2 class="text-lg font-semibold mb-4 flex justify-between items-center text-emerald-300"><span><i class="ph-fill ph-check-circle mr-2"></i><span data-lang-key="kanban_done">Selesai</span></span><span id="done-count" class="bg-emerald-800 text-emerald-200 text-xs font-bold px-2 py-1 rounded-full">0</span></h2><div id="done-column" class="task-column flex-grow overflow-y-auto custom-scrollbar pr-1 min-h-[200px]" data-status="done"></div></div>
                        </div>
                    </div>
                    <button id="scroll-right-btn" class="scroll-btn"><i class="ph-bold ph-caret-right text-2xl"></i></button>
                </div>
            </main>
            <main id="assets-view" class="main-view hidden flex-grow flex-col"><div class="mb-4 flex flex-col sm:flex-row gap-4"><div class="relative flex-grow"><input type="text" id="asset-search-input" data-lang-placeholder="asset_search_placeholder" class="w-full bg-slate-800/50 backdrop-blur-sm border border-white/10 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-teal-500 outline-none"><i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i></div></div><div id="assets-grid" class="flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto custom-scrollbar pr-2"></div></main>
            <main id="invoice-view" class="main-view hidden flex-grow flex-col">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2">
                        <form id="invoice-form" class="glass-panel rounded-xl p-6 space-y-4">
                            <h3 class="text-xl font-bold text-white border-b border-white/10 pb-3" data-lang-key="invoice_create_title">Buat Invoice</h3>
                            <div class="space-y-2"><h4 class="text-md font-semibold text-gray-300" data-lang-key="invoice_client_info">Informasi Klien</h4><div><label for="invoice-client-name" class="block text-sm font-medium text-gray-400" data-lang-key="client_name_label">Nama Klien</label><input type="text" id="invoice-client-name" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required></div><div><label for="invoice-client-email" class="block text-sm font-medium text-gray-400" data-lang-key="invoice_client_email">Email Klien</label><input type="email" id="invoice-client-email" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div><div><label for="invoice-due-date" class="block text-sm font-medium text-gray-400" data-lang-key="invoice_due_date">Tanggal Jatuh Tempo</label><input type="date" id="invoice-due-date" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div></div>
                            <div class="space-y-2 pt-4 border-t border-white/10"><h4 class="text-md font-semibold text-gray-300" data-lang-key="invoice_items">Item Tagihan</h4><div id="invoice-items-container" class="space-y-2"></div><button type="button" id="add-invoice-item-btn" class="w-full text-sm bg-slate-600/50 hover:bg-slate-500/50 py-2 rounded-lg" data-lang-key="invoice_add_item">+ Tambah Item</button></div>
                            <div class="space-y-2 pt-4 border-t border-white/10"><h4 class="text-md font-semibold text-gray-300" data-lang-key="invoice_payment_info">Informasi Pembayaran</h4><div><label for="invoice-bank-name" class="block text-sm font-medium text-gray-400" data-lang-key="invoice_bank_name">Nama Bank</label><select id="invoice-bank-name" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"><option value="BCA">BCA (Bank Central Asia)</option><option value="Mandiri">Mandiri</option><option value="BRI">BRI (Bank Rakyat Indonesia)</option><option value="BNI">BNI (Bank Negara Indonesia)</option><option value="CIMB">CIMB Niaga</option><option value="Permata">Bank Permata</option><option value="Lainnya">Lainnya</option></select></div><div><label for="invoice-account-name" class="block text-sm font-medium text-gray-400" data-lang-key="invoice_account_name">Nama Pemilik Rekening</label><input type="text" id="invoice-account-name" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div><div><label for="invoice-account-number" class="block text-sm font-medium text-gray-400" data-lang-key="invoice_account_number">Nomor Rekening</label><input type="text" id="invoice-account-number" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div></div>
                            <div class="pt-4 border-t border-white/10 flex justify-end gap-2"><button type="button" id="save-invoice-settings-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg" data-lang-key="invoice_save_bank_info" data-lang-title="invoice_save_bank_info_title">Simpan Info Bank</button><button type="button" id="export-pdf-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg" data-lang-key="invoice_export_pdf">Export PDF</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-3"><div id="invoice-preview-wrapper" class="bg-white text-gray-800 p-2 sm:p-4 rounded-lg shadow-2xl"><div id="invoice-preview" class="p-4 sm:p-8"></div></div></div>
                </div>
            </main>
            <main id="analytics-view" class="main-view hidden flex-grow flex-col"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div class="glass-panel p-4 rounded-xl text-center"><h3 class="text-lg font-semibold text-gray-300" data-lang-key="analytics_total_done">Total Proyek Selesai</h3><p id="analytics-total-done" class="text-4xl font-bold text-emerald-400 mt-2">0</p></div><div class="glass-panel p-4 rounded-xl text-center"><h3 class="text-lg font-semibold text-gray-300" data-lang-key="analytics_this_month">Proyek Bulan Ini</h3><p id="analytics-this-month" class="text-4xl font-bold text-cyan-400 mt-2">0</p></div><div class="glass-panel p-4 rounded-xl text-center"><h3 class="text-lg font-semibold text-gray-300" data-lang-key="analytics_avg_time">Rata-rata Waktu Pengerjaan</h3><p id="analytics-avg-time" class="text-4xl font-bold text-amber-400 mt-2">N/A</p></div></div><div class="grid grid-cols-1 xl:grid-cols-2 gap-6"><div class="glass-panel p-4 rounded-xl"><h3 class="text-lg font-semibold text-white mb-4" data-lang-key="analytics_completed_weekly">Proyek Selesai per Minggu</h3><canvas id="completed-tasks-chart"></canvas></div><div class="glass-panel p-4 rounded-xl"><h3 class="text-lg font-semibold text-white mb-4" data-lang-key="analytics_client_dist">Distribusi Konten per Klien</h3><canvas id="artist-distribution-chart"></canvas></div></div></main>
        </div>
    </div>
    
    <!-- Modals & Panels -->
    <div id="language-selection-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-panel glass-panel rounded-xl shadow-2xl p-8 w-full max-w-sm text-center transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold mb-2 text-white">Pilih Bahasa / Select Language</h3>
            <p class="text-gray-300 mb-6">Pilih bahasa antarmuka pilihan Anda.</p>
            <div class="flex flex-col gap-4">
                <button id="select-lang-id" class="w-full bg-slate-700 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-300">
                    ðŸ‡®ðŸ‡© Bahasa Indonesia
                </button>
                <button id="select-lang-en" class="w-full bg-slate-700 hover:bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-300">
                    ðŸ‡¬ðŸ‡§ English
                </button>
            </div>
        </div>
    </div>

    <!-- PENAMBAHAN: Modal Edit Profil digabung -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-panel glass-panel rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-95 opacity-0">
            <form id="edit-profile-form">
                <h3 class="text-2xl font-bold mb-6" data-lang-key="edit_profile_title">Ubah Profil</h3>
                <div class="space-y-4">
                    <div>
                        <label for="edit-profile-name-input" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="edit_profile_label">Nama Pengguna</label>
                        <input type="text" id="edit-profile-name-input" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required>
                    </div>
                    <div>
                        <label for="edit-company-name-input" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="company_name_label">Nama Perusahaan</label>
                        <input type="text" id="edit-company-name-input" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required>
                    </div>
                </div>
                <div id="edit-profile-message" class="hidden text-sm p-3 rounded-lg mt-4"></div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-profile-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg" data-lang-key="cancel_btn">Batal</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg flex items-center gap-2">
                        <span data-lang-key="save_btn">Simpan</span>
                        <div id="edit-profile-loader" class="loader hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="onboarding-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50"><div class="modal-panel glass-panel rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-95 opacity-0"><form id="onboarding-form"><h3 class="text-2xl font-bold mb-2 text-white" data-lang-key="welcome">Selamat Datang!</h3><p class="text-gray-300 mb-6" data-lang-key="complete_profile_prompt">Lengkapi profil Anda untuk mulai.</p><div class="space-y-4"><div><label for="profile-company-name" class="block text-sm font-medium text-gray-300" data-lang-key="company_name_label">Nama Perusahaan/Komunitas</label><input type="text" id="profile-company-name" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required></div><div><label for="profile-field" class="block text-sm font-medium text-gray-300" data-lang-key="field_label">Bergerak di Bidang</label><input type="text" id="profile-field" data-lang-placeholder="field_placeholder" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div><div><label for="profile-contact" class="block text-sm font-medium text-gray-300" data-lang-key="contact_label">Kontak (Email/No. HP)</label><input type="text" id="profile-contact" class="mt-1 w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div></div><div class="flex justify-end gap-4 mt-8"><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg flex items-center gap-2"><span data-lang-key="save_continue_btn">Simpan & Lanjutkan</span><div id="onboarding-loader" class="loader hidden"></div></button></div></form></div></div>
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50"><div class="modal-panel glass-panel rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-95 opacity-0"><form id="task-form"><input type="hidden" id="task-id"><h3 id="task-modal-title" class="text-2xl font-bold mb-6" data-lang-key="add_new_project_title">Tambah Proyek Baru</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div><label for="task-client-name" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="client_name_label">Nama Klien</label><input type="text" id="task-client-name" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required></div><div><label for="task-project-type" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="project_type_label">Jenis Proyek</label><input type="text" id="task-project-type" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div><div><label for="task-priority" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="priority_label">Prioritas</label><select id="task-priority" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"><option value="biasa" data-lang-key="priority_normal">Biasa</option><option value="penting" data-lang-key="priority_important">Penting</option><option value="mendesak" data-lang-key="priority_urgent">Mendesak</option></select></div><div><label for="task-deadline" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="deadline_label">Deadline</label><input type="date" id="task-deadline" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div><div class="sm:col-span-2"><label for="task-contact" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="client_contact_label">Kontak Klien</label><input type="text" id="task-contact" data-lang-placeholder="client_contact_placeholder" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div></div><div class="mb-6"><label for="brief" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="brief_notes_label">Brief / Catatan</label><textarea id="brief" rows="3" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></textarea></div><div class="flex justify-end gap-4"><button type="button" id="cancel-task-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg" data-lang-key="cancel_btn">Batal</button><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg" data-lang-key="save_btn">Simpan</button></div></form></div></div>
    <div id="asset-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50"><div class="modal-panel glass-panel rounded-xl shadow-2xl p-6 w-full max-w-lg transform scale-95 opacity-0"><form id="asset-form"><input type="hidden" id="asset-id"><h3 id="asset-modal-title" class="text-2xl font-bold mb-6" data-lang-key="add_new_asset_title">Tambah Aset Baru</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div class="sm:col-span-2"><label for="asset-file-link" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="asset_gdrive_link">Link Google Drive</label><input type="url" id="asset-file-link" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required></div><div><label for="asset-client-name" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="client_name_label">Nama Klien</label><input type="text" id="asset-client-name" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required></div><div><label for="asset-project-type" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="project_type_label">Jenis Proyek</label><input type="text" id="asset-project-type" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div><div><label for="asset-shoot-date" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="asset_shoot_date">Tanggal Syuting</label><input type="date" id="asset-shoot-date" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white" required></div><div><label for="asset-type" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="asset_type">Jenis Aset</label><select id="asset-type" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"><option value="mentah" data-lang-key="asset_type_raw">Footage Mentah</option><option value="final" data-lang-key="asset_type_final">Konten Final</option></select></div></div><div class="mb-6"><label for="asset-tags" class="block text-sm font-medium text-gray-300 mb-1" data-lang-key="asset_tags">Tags (pisahkan dengan koma)</label><input type="text" id="asset-tags" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-asset-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg" data-lang-key="cancel_btn">Batal</button><button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-5 rounded-lg" data-lang-key="save_btn">Simpan</button></div></form></div></div>
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50"><div class="modal-panel glass-panel rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform scale-95 opacity-0"><h3 class="text-lg font-bold text-white mb-2" data-lang-key="delete_confirm_title">Yakin ingin menghapus?</h3><p id="delete-item-name" class="text-gray-300 mb-6"></p><div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg" data-lang-key="cancel_btn">Batal</button><button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg" data-lang-key="delete_btn">Hapus</button></div></div></div>
    <div id="timer-alert-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50"><div class="modal-panel glass-panel rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform scale-95 opacity-0"><div class="text-yellow-400 mb-4"><i class="ph-fill ph-timer text-5xl"></i></div><h3 class="text-lg font-bold text-white mb-2" data-lang-key="timer_done_title">Sesi Fokus Selesai!</h3><p class="text-gray-300 mb-6" data-lang-key="timer_done_desc">Kerja bagus! Waktunya istirahat sejenak.</p><div class="flex justify-center"><button id="ok-timer-alert-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded-lg" data-lang-key="ok_btn">Oke</button></div></div></div>
    <div id="comments-panel-overlay" class="fixed inset-0 bg-black bg-opacity-70 hidden z-40"></div>
    <div id="comments-panel" class="side-panel glass-panel fixed top-0 right-0 h-full w-full max-w-md shadow-2xl transform translate-x-full z-50 flex flex-col"><div class="flex justify-between items-center p-4 border-b border-white/10 flex-shrink-0"><h3 id="comments-task-title" class="text-lg font-bold text-white truncate pr-4">Komentar</h3><button id="close-comments-btn" class="p-2 text-gray-400 hover:text-white"><i class="ph-bold ph-x text-xl"></i></button></div><div id="comments-list" class="flex-grow p-4 overflow-y-auto custom-scrollbar"></div><div class="p-4 border-t border-white/10 flex-shrink-0"><form id="comment-form" class="flex gap-2"><input type="text" id="comment-input" class="w-full bg-slate-700/50 border border-white/10 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none" data-lang-placeholder="comment_placeholder" required><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg flex items-center justify-center"><i class="ph-bold ph-paper-plane-tilt text-xl"></i></button></form></div></div>
    <div id="focus-bar" class="fixed bottom-0 left-0 right-0 glass-panel shadow-lg"><div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-2 grid grid-cols-2 md:grid-cols-3 items-center gap-4"><div class="flex items-center gap-3 justify-start"><i class="ph-bold ph-timer text-xl text-yellow-400"></i><span class="font-semibold text-white hidden sm:inline" data-lang-key="timer_title">Editor Focus</span><span id="timer-display" class="text-lg font-mono bg-slate-900/70 text-white px-2 py-0.5 rounded-md">30:00</span></div><div class="hidden md:flex flex-col items-center justify-center"><div class="w-full max-w-xs bg-slate-600/50 rounded-full h-2.5"><div id="timer-progress" class="bg-yellow-400 h-2.5 rounded-full" style="width: 100%;"></div></div></div><div class="flex items-center gap-4 justify-end">
        <div class="text-xs text-gray-500 hidden lg:block">FocusCut Version 0.2</div>
        <div class="flex items-center gap-2"><button id="start-timer-btn" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-full transition-colors"><i class="ph-bold ph-play"></i></button><button id="pause-timer-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full transition-colors hidden"><i class="ph-bold ph-pause"></i></button><button id="reset-timer-btn" class="bg-red-600 hover:bg-red-700 text-white p-2 rounded-full transition-colors"><i class="ph-bold ph-arrow-counter-clockwise"></i></button></div></div></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- KONFIGURASI FIREBASE (TIDAK DIUBAH) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCxeKFNLJurJd108Cfnotygm6FI9Mr9sQY",
            authDomain: "dashboard-editor-dermapro-sf.firebaseapp.com",
            databaseURL: "https://dashboard-editor-dermapro-sf-default-rtdb.firebaseio.com",
            projectId: "dashboard-editor-dermapro-sf",
            storageBucket: "dashboard-editor-dermapro-sf.appspot.com",
            messagingSenderId: "43085432214",
            appId: "1:43085432214:web:2548f67ecbff42e32b49b7",
            measurementId: "G-2M6VJTPYSN"
        };
        
        // --- INISIALISASI FIREBASE (TIDAK DIUBAH) ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userProfileData = {};
        let allTasksCache = [];
        let allAssetsCache = [];
        let unsubscribeComments = null;
        let completedTasksChart = null;
        let artistDistributionChart = null;
        let currentLanguage = 'id'; // Default language

        // --- ELEMEN UTAMA ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginErrorMsg = document.getElementById('login-error-message');

        // --- KAMUS TRANSLASI ---
        const translations = {
            id: {
                login_prompt: 'Masuk untuk melanjutkan ke dasbor Anda.', login_button: 'Masuk dengan Google', logged_in_as: 'Login sebagai:',
                change_bg_title: 'Ganti Latar Belakang', logout_title: 'Keluar', add_project_btn: 'Tambah Proyek', add_asset_btn: 'Tambah Aset',
                nav_kanban: 'Papan Proyek', nav_assets: 'Bank Konten', nav_invoice: 'Invoice', nav_analytics: 'Analitik',
                search_placeholder: 'Cari nama klien, proyek, atau tanggal (YYYY-MM-DD)...',
                sort_date_desc: 'Urutkan: Tanggal (Terbaru)', sort_date_asc: 'Urutkan: Tanggal (Terlama)', sort_name_az: 'Urutkan: Nama Klien (A-Z)', sort_name_za: 'Urutkan: Nama Klien (Z-A)',
                kanban_todo: 'List Konten', kanban_wip: 'Proses Editing', kanban_review: 'Review / Revisi', kanban_done: 'Selesai',
                asset_search_placeholder: 'Cari berdasarkan klien, proyek, atau tag...',
                welcome: 'Selamat Datang!', complete_profile_prompt: 'Lengkapi profil Anda untuk mulai.',
                company_name_label: 'Nama Perusahaan', field_label: 'Bergerak di Bidang', field_placeholder: 'cth: Video Editor, Agensi Kreatif', contact_label: 'Kontak (Email/No. HP)',
                save_continue_btn: 'Simpan & Lanjutkan',
                add_new_project_title: 'Tambah Proyek Baru', add_new_asset_title: 'Tambah Aset Baru',
                client_name_label: 'Nama Klien', project_type_label: 'Jenis Proyek',
                priority_label: 'Prioritas', priority_normal: 'Biasa', priority_important: 'Penting', priority_urgent: 'Mendesak',
                deadline_label: 'Deadline', client_contact_label: 'Kontak Klien', client_contact_placeholder: 'Email atau No. HP', brief_notes_label: 'Brief / Catatan',
                cancel_btn: 'Batal', save_btn: 'Simpan', delete_confirm_title: 'Yakin ingin menghapus?', delete_btn: 'Hapus',
                edit_profile_title: 'Ubah Profil', edit_profile_label: 'Nama Pengguna',
                comment_placeholder: 'Tulis komentar...', comment_title_prefix: 'Catatan untuk:', no_comments: 'Belum ada komentar.', comment_load_error: 'Gagal memuat komentar.',
                profile_update_success: 'Profil berhasil diperbarui!', profile_update_error: 'Gagal memperbarui profil.',
                asset_gdrive_link: 'Link Google Drive', asset_shoot_date: 'Tanggal Syuting', asset_type: 'Jenis Aset', asset_type_raw: 'Footage Mentah', asset_type_final: 'Konten Final', asset_tags: 'Tags (pisahkan dengan koma)',
                invoice_create_title: 'Buat Invoice', invoice_client_info: 'Informasi Klien', invoice_client_email: 'Email Klien', invoice_due_date: 'Tanggal Jatuh Tempo', invoice_items: 'Item Tagihan', invoice_add_item: '+ Tambah Item', invoice_payment_info: 'Informasi Pembayaran', invoice_bank_name: 'Nama Bank', invoice_account_name: 'Nama Pemilik Rekening', invoice_account_number: 'Nomor Rekening', invoice_save_bank_info: 'Simpan Info Bank', invoice_save_bank_info_title: 'Simpan Info Bank', invoice_export_pdf: 'Export PDF',
                analytics_total_done: 'Total Proyek Selesai', analytics_this_month: 'Proyek Bulan Ini', analytics_avg_time: 'Rata-rata Waktu Pengerjaan', analytics_completed_weekly: 'Proyek Selesai per Minggu', analytics_client_dist: 'Distribusi Konten per Klien',
                timer_title: 'Editor Focus', timer_done_title: 'Sesi Fokus Selesai!', timer_done_desc: 'Kerja bagus! Waktunya istirahat sejenak.', ok_btn: 'Oke'
            },
            en: {
                login_prompt: 'Sign in to continue to your dashboard.', login_button: 'Sign in with Google', logged_in_as: 'Logged in as:',
                change_bg_title: 'Change Background', logout_title: 'Logout', add_project_btn: 'Add Project', add_asset_btn: 'Add Asset',
                nav_kanban: 'Project Board', nav_assets: 'Content Bank', nav_invoice: 'Invoice', nav_analytics: 'Analytics',
                search_placeholder: 'Search client name, project, or date (YYYY-MM-DD)...',
                sort_date_desc: 'Sort by: Date (Newest)', sort_date_asc: 'Sort by: Date (Oldest)', sort_name_az: 'Sort by: Client Name (A-Z)', sort_name_za: 'Sort by: Client Name (Z-A)',
                kanban_todo: 'Content List', kanban_wip: 'Editing Process', kanban_review: 'Review / Revision', kanban_done: 'Completed',
                asset_search_placeholder: 'Search by client, project, or tags...',
                welcome: 'Welcome!', complete_profile_prompt: 'Complete your profile to get started.',
                company_name_label: 'Company Name', field_label: 'Field of Business', field_placeholder: 'e.g., Video Editor, Creative Agency', contact_label: 'Contact (Email/Phone No.)',
                save_continue_btn: 'Save & Continue',
                add_new_project_title: 'Add New Project', add_new_asset_title: 'Add New Asset',
                client_name_label: 'Client Name', project_type_label: 'Project Type',
                priority_label: 'Priority', priority_normal: 'Normal', priority_important: 'Important', priority_urgent: 'Urgent',
                deadline_label: 'Deadline', client_contact_label: 'Client Contact', client_contact_placeholder: 'Email or Phone No.', brief_notes_label: 'Brief / Notes',
                cancel_btn: 'Cancel', save_btn: 'Save', delete_confirm_title: 'Are you sure you want to delete?', delete_btn: 'Delete',
                edit_profile_title: 'Edit Profile', edit_profile_label: 'Username',
                comment_placeholder: 'Write a comment...', comment_title_prefix: 'Notes for:', no_comments: 'No comments yet.', comment_load_error: 'Failed to load comments.',
                profile_update_success: 'Profile updated successfully!', profile_update_error: 'Failed to update profile.',
                asset_gdrive_link: 'Google Drive Link', asset_shoot_date: 'Shoot Date', asset_type: 'Asset Type', asset_type_raw: 'Raw Footage', asset_type_final: 'Final Content', asset_tags: 'Tags (comma separated)',
                invoice_create_title: 'Create Invoice', invoice_client_info: 'Client Information', invoice_client_email: 'Client Email', invoice_due_date: 'Due Date', invoice_items: 'Billable Items', invoice_add_item: '+ Add Item', invoice_payment_info: 'Payment Information', invoice_bank_name: 'Bank Name', invoice_account_name: 'Account Holder Name', invoice_account_number: 'Account Number', invoice_save_bank_info: 'Save Bank Info', invoice_save_bank_info_title: 'Save Bank Info', invoice_export_pdf: 'Export PDF',
                analytics_total_done: 'Total Completed Projects', analytics_this_month: 'Projects This Month', analytics_avg_time: 'Average Completion Time', analytics_completed_weekly: 'Projects Completed per Week', analytics_client_dist: 'Content Distribution per Client',
                timer_title: 'Editor Focus', timer_done_title: 'Focus Session Complete!', timer_done_desc: 'Great work! Time for a short break.', ok_btn: 'OK'
            }
        };

        // --- FUNGSI MODAL HELPER ---
        const openModal = (modalElement) => { if (modalElement) { modalElement.classList.remove('hidden'); setTimeout(() => { if (modalElement.firstElementChild) modalElement.firstElementChild.classList.remove('scale-95', 'opacity-0'); }, 10); }};
        const closeModal = (modalElement) => { if (modalElement) { if (modalElement.firstElementChild) modalElement.firstElementChild.classList.add('scale-95', 'opacity-0'); setTimeout(() => modalElement.classList.add('hidden'), 300); }};

        // --- FUNGSI BAHASA ---
        function applyLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            document.documentElement.lang = lang;
            document.getElementById('language-flag').textContent = lang === 'id' ? 'ðŸ‡®ðŸ‡©' : 'ðŸ‡¬ðŸ‡§';

            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) el.textContent = translations[lang][key];
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (translations[lang] && translations[lang][key]) el.placeholder = translations[lang][key];
            });
            document.querySelectorAll('[data-lang-title]').forEach(el => {
                const key = el.dataset.langTitle;
                if (translations[lang] && translations[lang][key]) el.title = translations[lang][key];
            });
        }

        function setupLanguageSwitcher() {
            const langModal = document.getElementById('language-selection-modal');
            document.getElementById('select-lang-id').addEventListener('click', () => {
                applyLanguage('id');
                closeModal(langModal);
                if (!userProfileData.companyName) {
                    openModal(document.getElementById('onboarding-modal'));
                } else {
                    initializeAppUI(currentUser, userProfileData);
                }
            });
            document.getElementById('select-lang-en').addEventListener('click', () => {
                applyLanguage('en');
                closeModal(langModal);
                if (!userProfileData.companyName) {
                    openModal(document.getElementById('onboarding-modal'));
                } else {
                     initializeAppUI(currentUser, userProfileData);
                }
            });
            document.getElementById('language-switcher-btn').addEventListener('click', () => openModal(langModal));
        }

        // --- LOGIKA OTENTIKASI (TIDAK DIUBAH) ---
        const provider = new firebase.auth.GoogleAuthProvider();
        googleLoginBtn.addEventListener('click', () => {
            auth.signInWithPopup(provider).catch((error) => {
                console.error("Firebase Login Error:", error);
                loginErrorMsg.textContent = `Error: ${error.message}`;
                loginErrorMsg.classList.remove('hidden');
            });
        });

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const whitelistRef = db.collection('whitelisted_users').doc(user.email);
                try {
                    const doc = await whitelistRef.get();
                    if (doc.exists) {
                        userProfileData = doc.data();
                        startAppFlow(user, userProfileData);
                    } else {
                        loginErrorMsg.textContent = "Akses ditolak. Email Anda tidak terdaftar.";
                        loginErrorMsg.classList.remove('hidden');
                        await auth.signOut();
                    }
                } catch (error) {
                    console.error("ERROR saat get() dari Firestore:", error);
                    loginErrorMsg.textContent = "Gagal memverifikasi akun. Cek aturan keamanan Firestore.";
                    loginErrorMsg.classList.remove('hidden');
                    await auth.signOut();
                }
            } else {
                currentUser = null;
                loginScreen.style.display = 'flex';
                appScreen.style.display = 'none';
            }
        });

        // --- FUNGSI ALUR APLIKASI UTAMA ---
        function startAppFlow(user, profileData) {
            loginScreen.style.display = 'none';
            setupLanguageSwitcher(); 
            
            const preferredLanguage = localStorage.getItem('preferredLanguage');
            if (preferredLanguage) {
                applyLanguage(preferredLanguage);
                if (profileData && profileData.companyName) {
                    initializeAppUI(user, profileData);
                } else {
                    openModal(document.getElementById('onboarding-modal'));
                    setupOnboarding(user, profileData || {});
                }
            } else {
                openModal(document.getElementById('language-selection-modal'));
            }
        }

        function setupOnboarding(user, existingData) {
            const onboardingForm = document.getElementById('onboarding-form');
            onboardingForm.onsubmit = async (e) => {
                e.preventDefault();
                const newProfileData = {
                    ...existingData, uid: user.uid, displayName: user.displayName, email: user.email, photoURL: user.photoURL,
                    companyName: document.getElementById('profile-company-name').value,
                    field: document.getElementById('profile-field').value,
                    contact: document.getElementById('profile-contact').value,
                    profileCompletedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                try {
                    await db.collection('whitelisted_users').doc(user.email).update(newProfileData);
                    closeModal(document.getElementById('onboarding-modal'));
                    initializeAppUI(user, newProfileData);
                } catch (error) {
                    console.error("Gagal memperbarui profil:", error);
                }
            };
        }

        // --- FUNGSI INISIALISASI UI UTAMA (LENGKAP) ---
        function initializeAppUI(user, profileData) {
            appScreen.style.display = 'flex';
            updateCompanyNameUI(profileData.companyName || 'Nama Perusahaan');
            updateUserDisplayNameUI(profileData.displayName || user.displayName);
            document.getElementById('profile-pic').src = profileData.photoURL || user.photoURL || 'https://placehold.co/100x100/1e293b/94a3b8?text=User';
            if (profileData.backgroundURL) {
                document.body.style.backgroundImage = `url('${profileData.backgroundURL}')`;
            }

            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            
            // Setup semua fitur
            setupProfileEditor(user); 
            setupProfilePicUpload(user, profileData);
            setupBgUpload(user);
            setupNavigation();
            setupModals(user);
            setupKanbanInteractions(user, profileData);
            setupAssetInteractions();
            setupCommentSubmission(user, profileData);
            setupInvoiceGenerator(user, profileData);
            setupTimer();
            setupTaskSearchAndSort();
            setupAssetSearch();
            
            // Listener data
            listenToTasks(user.uid);
            listenToAssets(user.uid);

            // Terapkan bahasa ke elemen yang mungkin baru ditampilkan
            applyLanguage(currentLanguage);
        }

        // --- FUNGSI EDIT PROFIL ---
        function updateUserDisplayNameUI(newName) {
            document.getElementById('user-name-display').textContent = newName;
        }
        function updateCompanyNameUI(newName) {
            document.getElementById('company-name-display').textContent = newName;
        }

        function setupProfileEditor(user) {
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const editCompanyBtn = document.getElementById('edit-company-btn');
            const editProfileModal = document.getElementById('edit-profile-modal');
            const editProfileForm = document.getElementById('edit-profile-form');
            const nameInput = document.getElementById('edit-profile-name-input');
            const companyNameInput = document.getElementById('edit-company-name-input');
            const cancelBtn = document.getElementById('cancel-edit-profile-btn');
            const loader = document.getElementById('edit-profile-loader');
            const messageEl = document.getElementById('edit-profile-message');

            const openEditModal = () => {
                nameInput.value = userProfileData.displayName || user.displayName;
                companyNameInput.value = userProfileData.companyName || '';
                messageEl.classList.add('hidden');
                openModal(editProfileModal);
            };

            editProfileBtn.addEventListener('click', openEditModal);
            editCompanyBtn.addEventListener('click', openEditModal);

            cancelBtn.addEventListener('click', () => closeModal(editProfileModal));

            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = nameInput.value.trim();
                const newCompanyName = companyNameInput.value.trim();
                
                const updateData = {};
                if (newName && newName !== userProfileData.displayName) {
                    updateData.displayName = newName;
                }
                if (newCompanyName && newCompanyName !== userProfileData.companyName) {
                    updateData.companyName = newCompanyName;
                }

                if (Object.keys(updateData).length === 0) {
                    closeModal(editProfileModal);
                    return;
                }

                loader.classList.remove('hidden');
                try {
                    await db.collection('whitelisted_users').doc(user.email).update(updateData);
                    
                    if(updateData.displayName) {
                        userProfileData.displayName = updateData.displayName;
                        updateUserDisplayNameUI(updateData.displayName);
                    }
                    if(updateData.companyName) {
                        userProfileData.companyName = updateData.companyName;
                        updateCompanyNameUI(updateData.companyName);
                    }
                    
                    messageEl.textContent = translations[currentLanguage].profile_update_success;
                    messageEl.className = 'text-sm bg-green-900/50 text-green-300 p-3 rounded-lg mt-4';
                    messageEl.classList.remove('hidden');
                    setTimeout(() => { closeModal(editProfileModal); loader.classList.add('hidden'); }, 1500);
                } catch (error) {
                    console.error("Error updating profile:", error);
                    messageEl.textContent = translations[currentLanguage].profile_update_error;
                    messageEl.className = 'text-sm bg-red-900/50 text-red-300 p-3 rounded-lg mt-4';
                    messageEl.classList.remove('hidden');
                    loader.classList.add('hidden');
                }
            });
        }
        
        // --- SEMUA FUNGSI ASLI DIKEMBALIKAN ---
        function setupTaskSearchAndSort() {
            const taskSearchInput = document.getElementById('task-search-input');
            const taskSortSelect = document.getElementById('task-sort-select');
            taskSearchInput.addEventListener('input', filterAndSortTasks);
            taskSortSelect.addEventListener('change', filterAndSortTasks);
        }

        function filterAndSortTasks() {
            const taskSearchInput = document.getElementById('task-search-input');
            const taskSortSelect = document.getElementById('task-sort-select');
            const searchTerm = taskSearchInput.value.toLowerCase();
            const sortBy = taskSortSelect.value;
            let processedTasks = allTasksCache.filter(task => {
                if (!searchTerm) return true;
                const clientName = task.clientName?.toLowerCase() || '';
                const projectType = task.projectType?.toLowerCase() || '';
                const deadline = task.deadline || '';
                return clientName.includes(searchTerm) || projectType.includes(searchTerm) || deadline.includes(searchTerm);
            });
            processedTasks.sort((a, b) => {
                switch (sortBy) {
                    case 'date_desc': return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                    case 'date_asc': return (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0);
                    case 'name_az': return (a.clientName || '').localeCompare(b.clientName || '');
                    case 'name_za': return (b.clientName || '').localeCompare(a.clientName || '');
                    default: return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                }
            });
            renderAllTasks(processedTasks);
        }

        function setupAssetSearch() {
            const assetSearchInput = document.getElementById('asset-search-input');
            assetSearchInput.addEventListener('input', filterAssets);
        }

        function filterAssets() {
            const assetSearchInput = document.getElementById('asset-search-input');
            const searchTerm = assetSearchInput.value.toLowerCase();
            const filteredAssets = allAssetsCache.filter(asset => {
                if (!searchTerm) return true;
                const clientName = asset.clientName?.toLowerCase() || '';
                const projectType = asset.projectType?.toLowerCase() || '';
                const tags = (asset.tags || []).join(' ').toLowerCase();
                return clientName.includes(searchTerm) || projectType.includes(searchTerm) || tags.includes(searchTerm);
            });
            renderAllAssets(filteredAssets);
        }

        function listenToTasks(uid) {
            db.collection('tasks').where('ownerId', '==', uid).onSnapshot(snapshot => {
                allTasksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterAndSortTasks();
                updateAnalytics(allTasksCache);
            }, error => console.error("Error mendengarkan perubahan proyek:", error));
        }
        
        function renderAllTasks(tasksToRender) {
            const columns = { todo: document.getElementById('todo-column'), wip: document.getElementById('wip-column'), review: document.getElementById('review-column'), done: document.getElementById('done-column') };
            const counts = { todo: 0, wip: 0, review: 0, done: 0 };
            Object.values(columns).forEach(col => col.innerHTML = '');
            tasksToRender.forEach(task => {
                if (columns[task.status]) {
                    const taskCard = document.createElement('div');
                    taskCard.className = `task-card glass-card p-4 rounded-lg mb-4 border-l-4 priority-${task.priority}`;
                    taskCard.dataset.id = task.id;
                    taskCard.setAttribute('draggable', 'true');
                    taskCard.innerHTML = `<div class="card-actions"><button class="action-btn comment-task-btn" title="Komentar" data-id="${task.id}"><i class="ph-bold ph-chat-circle-dots text-sm"></i></button><button class="action-btn delete-task-btn" title="Hapus Proyek" data-id="${task.id}"><i class="ph-bold ph-trash text-sm"></i></button></div><h4 class="font-bold text-white pr-16">${task.clientName}</h4><p class="text-sm text-gray-300 mb-2">${task.projectType}</p><p class="text-xs text-gray-400 mb-3 break-words">${task.brief || ''}</p><div class="flex justify-between items-center text-xs text-gray-400"><span><i class="ph-fill ph-calendar-blank mr-1"></i>${task.deadline || 'No date'}</span><span class="font-bold uppercase text-indigo-300">${task.priority}</span></div>`;
                    columns[task.status].appendChild(taskCard);
                    counts[task.status]++;
                }
            });
            document.getElementById('todo-count').textContent = counts.todo;
            document.getElementById('wip-count').textContent = counts.wip;
            document.getElementById('review-count').textContent = counts.review;
            document.getElementById('done-count').textContent = counts.done;
            setTimeout(() => document.getElementById('kanban-scroll-wrapper')?.dispatchEvent(new Event('scroll')), 100);
        }

        function setupInvoiceGenerator(user, profileData) {
            const invoiceForm = document.getElementById('invoice-form');
            const itemsContainer = document.getElementById('invoice-items-container');
            const addItemBtn = document.getElementById('add-invoice-item-btn');
            const previewContainer = document.getElementById('invoice-preview');
            const saveSettingsBtn = document.getElementById('save-invoice-settings-btn');
            const bankNameInput = document.getElementById('invoice-bank-name');
            const accountNameInput = document.getElementById('invoice-account-name');
            const accountNumberInput = document.getElementById('invoice-account-number');
            bankNameInput.value = profileData.bankName || 'BCA';
            accountNameInput.value = profileData.accountName || '';
            accountNumberInput.value = profileData.accountNumber || '';
            saveSettingsBtn.addEventListener('click', () => {
                const newSettings = { bankName: bankNameInput.value, accountName: accountNameInput.value, accountNumber: accountNumberInput.value, };
                db.collection('whitelisted_users').doc(user.email).update(newSettings) .then(() => alert('Informasi bank berhasil disimpan!')) .catch(err => console.error('Gagal simpan info bank:', err));
            });
            const renderPreview = () => {
                const clientName = document.getElementById('invoice-client-name').value || 'Nama Klien';
                const clientEmail = document.getElementById('invoice-client-email').value || 'email@klien.com';
                const dueDateValue = document.getElementById('invoice-due-date').value;
                const bankName = bankNameInput.value;
                const accountName = accountNameInput.value;
                const accountNumber = accountNumberInput.value;
                let itemsHtml = '';
                let total = 0;
                const items = itemsContainer.querySelectorAll('.invoice-item');
                items.forEach((item, index) => {
                    const desc = item.querySelector('.item-desc').value || 'Deskripsi Layanan';
                    const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
                    const price = parseFloat(item.querySelector('.item-price').value) || 0;
                    const itemTotal = qty * price;
                    total += itemTotal;
                    itemsHtml += `<tr class="border-b border-gray-200"><td class="py-2 pr-2 w-8 text-center">${index + 1}</td><td class="py-2 pr-2">${desc}</td><td class="py-2 text-center">${qty}x</td><td class="py-2 text-right">Rp ${price.toLocaleString('id-ID')}</td><td class="py-2 text-right">Rp ${itemTotal.toLocaleString('id-ID')}</td></tr>`;
                });
                const today = new Date();
                let dueDate = new Date();
                if (dueDateValue) { const [year, month, day] = dueDateValue.split('-'); dueDate = new Date(year, month - 1, day); } else { dueDate.setDate(today.getDate() + 7); }
                const formattedDueDate = dueDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                const companyLogo = profileData.photoURL || user.photoURL || 'https://placehold.co/100x100/1e293b/94a3b8?text=Logo';
                previewContainer.innerHTML = `<div class="flex justify-between items-start mb-8"><div><img src="${companyLogo}" alt="Company Logo" class="w-24 h-24 rounded-lg object-cover mb-4" crossorigin="anonymous"><h2 class="text-2xl font-bold text-gray-800">${profileData.companyName || 'Nama Perusahaan Anda'}</h2><p class="text-gray-500 text-sm">${profileData.contact || 'Kontak Anda'}</p></div><div class="text-right"><h1 class="text-4xl font-bold text-gray-800 uppercase">INVOICE</h1><p class="text-gray-500 mt-2">No. Invoice: INV-${Date.now().toString().slice(-6)}</p><p class="text-gray-500">Tanggal: ${today.toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p></div></div><div class="flex justify-between mb-8"><div><h3 class="font-semibold text-gray-500 mb-1">Ditagihkan kepada:</h3><p class="font-bold text-gray-800">${clientName}</p><p class="text-gray-600">${clientEmail}</p></div><div class="text-right"><h3 class="font-semibold text-gray-500 mb-1">Jatuh Tempo:</h3><p class="font-bold text-gray-800">${formattedDueDate}</p></div></div><table class="w-full mb-8 text-sm"><thead><tr class="bg-gray-100 text-left text-gray-600 uppercase"><th class="py-2 px-2 font-semibold text-center">No</th><th class="py-2 px-2 font-semibold">Layanan</th><th class="py-2 px-2 font-semibold text-center">Jumlah</th><th class="py-2 px-2 font-semibold text-right">Harga</th><th class="py-2 px-2 font-semibold text-right">Total</th></tr></thead><tbody>${itemsHtml}</tbody></table><div class="flex justify-end mb-8"><div class="w-full sm:w-1/2"><div class="flex justify-between font-bold text-gray-800 text-lg bg-gray-100 p-3 rounded-lg"><p>TOTAL</p><p>Rp ${total.toLocaleString('id-ID')}</p></div></div></div><div class="border-t pt-4"><h3 class="font-semibold text-gray-500 mb-2">Metode Pembayaran</h3><p class="text-gray-800"><span class="font-bold">${bankName}:</span> ${accountNumber}</p><p class="text-gray-800">A/N: <span class="font-bold">${accountName}</span></p></div><div class="text-center text-gray-400 text-xs mt-12"><p>Terima kasih atas kerja samanya!</p></div>`;
            };
            const addInvoiceItem = () => {
                const itemEl = document.createElement('div');
                itemEl.className = 'grid grid-cols-12 gap-2 invoice-item items-center';
                itemEl.innerHTML = `<input type="text" placeholder="Deskripsi" class="item-desc col-span-5 bg-slate-800/50 border border-white/10 rounded-md px-2 py-1 text-white text-sm"><input type="number" placeholder="Qty" value="1" class="item-qty col-span-2 bg-slate-800/50 border border-white/10 rounded-md px-2 py-1 text-white text-sm"><input type="number" placeholder="Harga" class="item-price col-span-4 bg-slate-800/50 border border-white/10 rounded-md px-2 py-1 text-white text-sm"><button type="button" class="remove-item-btn col-span-1 text-red-400 hover:text-red-600 text-2xl">&times;</button>`;
                itemsContainer.appendChild(itemEl);
                itemEl.querySelector('.remove-item-btn').addEventListener('click', () => { itemEl.remove(); renderPreview(); });
            };
            const exportInvoice = () => {
                const previewWrapper = document.getElementById('invoice-preview-wrapper');
                html2canvas(previewWrapper, { scale: 2, useCORS: true }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps= pdf.getImageProperties(imgData);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`invoice-${Date.now()}.pdf`);
                });
            };
            addItemBtn.addEventListener('click', addInvoiceItem);
            invoiceForm.addEventListener('input', renderPreview);
            document.getElementById('export-pdf-btn').addEventListener('click', exportInvoice);
            addInvoiceItem();
            renderPreview();
        }

        function setupCommentSubmission(user, profileData) {
            const form = document.getElementById('comment-form');
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            newForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const taskId = newForm.dataset.taskId;
                if (!taskId) { console.error("ID Proyek tidak ditemukan untuk mengirim komentar."); return; }
                const input = document.getElementById('comment-input');
                const text = input.value.trim();
                if (!text) return;
                const commentData = { text: text, authorId: user.uid, authorName: profileData.displayName || user.displayName, authorPhotoURL: profileData.photoURL || user.photoURL, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                db.collection('tasks').doc(taskId).collection('comments').add(commentData) .then(() => { input.value = ''; }) .catch(err => { console.error("Gagal mengirim komentar:", err); alert("Gagal mengirim komentar. Pastikan aturan keamanan Firebase sudah benar."); });
            });
        }
        function openCommentsPanel(taskId, taskTitle) {
            const panel = document.getElementById('comments-panel');
            const overlay = document.getElementById('comments-panel-overlay');
            const titleEl = document.getElementById('comments-task-title');
            const form = document.getElementById('comment-form');
            titleEl.textContent = `${translations[currentLanguage].comment_title_prefix} ${taskTitle}`;
            form.dataset.taskId = taskId;
            if (unsubscribeComments) unsubscribeComments();
            document.body.classList.add('comments-open');
            overlay.classList.remove('hidden');
            panel.classList.remove('translate-x-full');
            listenToComments(taskId);
        }
        function closeCommentsPanel() {
            if (unsubscribeComments) { unsubscribeComments(); unsubscribeComments = null; }
            document.body.classList.remove('comments-open');
            document.getElementById('comments-panel-overlay').classList.add('hidden');
            document.getElementById('comments-panel').classList.add('translate-x-full');
            document.getElementById('comment-form').removeAttribute('data-task-id');
        }
        document.getElementById('close-comments-btn').addEventListener('click', closeCommentsPanel);
        document.getElementById('comments-panel-overlay').addEventListener('click', closeCommentsPanel);
        function listenToComments(taskId) {
            const commentsList = document.getElementById('comments-list');
            const commentsPath = db.collection('tasks').doc(taskId).collection('comments').orderBy('createdAt', 'asc');
            unsubscribeComments = commentsPath.onSnapshot(snapshot => {
                commentsList.innerHTML = '';
                if (snapshot.empty) { commentsList.innerHTML = `<p class="text-center text-gray-400 mt-4">${translations[currentLanguage].no_comments}</p>`; return; }
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentEl = document.createElement('div');
                    commentEl.className = 'flex items-start gap-3 mb-4';
                    const commentDate = comment.createdAt?.toDate().toLocaleString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) || 'Baru saja';
                    commentEl.innerHTML = `<img src="${comment.authorPhotoURL || 'https://placehold.co/40x40'}" class="w-8 h-8 rounded-full object-cover mt-1"><div class="flex-1 bg-slate-700/50 rounded-lg p-3"><div class="flex justify-between items-center mb-1"><span class="font-semibold text-white text-sm">${comment.authorName}</span><span class="text-xs text-gray-400">${commentDate}</span></div><p class="text-sm text-gray-200 whitespace-pre-wrap">${comment.text}</p></div>`;
                    commentsList.appendChild(commentEl);
                });
                commentsList.scrollTop = commentsList.scrollHeight;
            }, err => { console.error("Gagal memuat komentar:", err); commentsList.innerHTML = `<p class="text-center text-red-400 mt-4">${translations[currentLanguage].comment_load_error}</p>`; });
        }
        
        function setupKanbanInteractions(user, profileData) {
            const kanbanBoard = document.getElementById('kanban-board');
            kanbanBoard.addEventListener('click', e => {
                const deleteBtn = e.target.closest('.delete-task-btn');
                const commentBtn = e.target.closest('.comment-task-btn');
                if (deleteBtn) { const taskId = deleteBtn.dataset.id; const taskName = allTasksCache.find(t => t.id === taskId)?.clientName || 'proyek ini'; openDeleteConfirmation(taskId, taskName, 'task'); }
                if (commentBtn) { const taskId = commentBtn.dataset.id; const taskTitle = allTasksCache.find(t => t.id === taskId)?.clientName || 'Proyek'; openCommentsPanel(taskId, taskTitle); }
            });
            const scrollWrapper = document.getElementById('kanban-scroll-wrapper');
            const scrollLeftBtn = document.getElementById('scroll-left-btn');
            const scrollRightBtn = document.getElementById('scroll-right-btn');
            const checkScroll = () => { if (!scrollWrapper) return; const maxScrollLeft = scrollWrapper.scrollWidth - scrollWrapper.clientWidth; scrollLeftBtn.style.display = scrollWrapper.scrollLeft > 0 ? 'flex' : 'none'; scrollRightBtn.style.display = scrollWrapper.scrollLeft < maxScrollLeft - 1 ? 'flex' : 'none'; };
            scrollLeftBtn.addEventListener('click', () => { scrollWrapper.scrollBy({ left: -350, behavior: 'smooth' }); });
            scrollRightBtn.addEventListener('click', () => { scrollWrapper.scrollBy({ left: 350, behavior: 'smooth' }); });
            scrollWrapper.addEventListener('scroll', checkScroll);
            window.addEventListener('resize', checkScroll);
            setTimeout(checkScroll, 500);
            let draggedItemId = null;
            kanbanBoard.addEventListener('dragstart', e => { const target = e.target.closest('.task-card'); if (target) { draggedItemId = target.dataset.id; e.dataTransfer.setData('text/plain', draggedItemId); setTimeout(() => target.classList.add('dragging'), 0); } });
            kanbanBoard.addEventListener('dragend', e => { const target = e.target.closest('.task-card'); if (target) target.classList.remove('dragging'); draggedItemId = null; });
            document.querySelectorAll('.task-column').forEach(column => {
                column.addEventListener('dragover', e => { e.preventDefault(); column.classList.add('drag-over'); });
                column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
                column.addEventListener('drop', e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    const newStatus = column.dataset.status;
                    const droppedItemId = e.dataTransfer.getData('text/plain');
                    if (droppedItemId && newStatus) {
                        const taskRef = db.collection('tasks').doc(droppedItemId);
                        const updateData = { status: newStatus };
                        if (newStatus === 'done') { updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp(); }
                        taskRef.update(updateData).catch(err => console.error("Gagal update status:", err));
                    }
                });
            });
        }
        function setupAssetInteractions() {
            const assetsGrid = document.getElementById('assets-grid');
            assetsGrid.addEventListener('click', e => {
                const deleteBtn = e.target.closest('.delete-asset-btn');
                if (deleteBtn) { e.preventDefault(); const assetId = deleteBtn.dataset.id; const assetName = allAssetsCache.find(a => a.id === assetId)?.clientName || 'aset ini'; openDeleteConfirmation(assetId, assetName, 'asset'); }
            });
        }
        function openDeleteConfirmation(itemId, itemName, itemType) {
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            document.getElementById('delete-item-name').textContent = `"${itemName}" akan dihapus permanen.`;
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const newConfirmBtn = confirmDeleteBtn.cloneNode(true);
            newConfirmBtn.textContent = translations[currentLanguage].delete_btn; // Update button text
            confirmDeleteBtn.parentNode.replaceChild(newConfirmBtn, confirmDeleteBtn);
            newConfirmBtn.addEventListener('click', () => {
                const collectionName = itemType === 'task' ? 'tasks' : 'assets';
                db.collection(collectionName).doc(itemId).delete().catch(err => console.error(`Gagal menghapus ${itemType}:`, err));
                closeModal(deleteConfirmModal);
            });
            document.getElementById('cancel-delete-btn').onclick = () => closeModal(deleteConfirmModal);
            openModal(deleteConfirmModal);
        }
        
        function renderAllAssets(assetsToRender) {
            const grid = document.getElementById('assets-grid');
            grid.innerHTML = '';
            if (assetsToRender.length === 0) {
                grid.innerHTML = `<p class="text-center text-gray-400 col-span-full mt-8">Aset tidak ditemukan.</p>`;
                return;
            }
            assetsToRender.forEach(asset => {
                const assetCard = document.createElement('a');
                assetCard.href = asset.fileLink;
                assetCard.target = "_blank";
                assetCard.className = 'glass-card p-4 rounded-lg block';
                assetCard.innerHTML = `<div class="card-actions"><button class="action-btn delete-asset-btn" title="Hapus Aset" data-id="${asset.id}"><i class="ph-bold ph-trash text-sm"></i></button></div><h4 class="font-bold text-white truncate pr-8">${asset.clientName}</h4><p class="text-sm text-gray-300 mb-2">${asset.projectType}</p><div class="flex flex-wrap gap-1 mt-2">${(asset.tags || []).map(tag => `<span class="text-xs bg-teal-800 text-teal-200 px-2 py-1 rounded-full">${tag}</span>`).join('')}</div><p class="text-xs text-gray-400 mt-3">Tgl Syuting: ${asset.shootDate}</p>`;
                grid.appendChild(assetCard);
            });
        }
        
        function listenToAssets(uid) {
            db.collection('assets').where('ownerId', '==', uid).onSnapshot(snapshot => {
                allAssetsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterAssets();
            }, error => console.error("Error mendengarkan perubahan aset:", error));
        }

        function updateAnalytics(tasks) {
            const doneTasks = tasks.filter(task => task.status === 'done' && task.completedAt);
            const now = new Date();
            document.getElementById('analytics-total-done').textContent = doneTasks.length;
            const thisMonthTasks = doneTasks.filter(task => { const completedDate = task.completedAt.toDate(); return completedDate.getMonth() === now.getMonth() && completedDate.getFullYear() === now.getFullYear(); });
            document.getElementById('analytics-this-month').textContent = thisMonthTasks.length;
            let totalDuration = 0; let tasksWithDuration = 0;
            doneTasks.forEach(task => { if(task.createdAt && task.completedAt) { const created = task.createdAt.toDate(); const completed = task.completedAt.toDate(); const duration = (completed - created) / (1000 * 60 * 60 * 24); totalDuration += duration; tasksWithDuration++; } });
            const avgTime = tasksWithDuration > 0 ? (totalDuration / tasksWithDuration).toFixed(1) : 'N/A';
            document.getElementById('analytics-avg-time').textContent = `${avgTime} hari`;
            const weeklyData = {};
            for(let i=6; i>=0; i--) { const day = dateFns.subDays(now, i); const formattedDay = dateFns.format(day, 'dd/MM'); weeklyData[formattedDay] = 0; }
            doneTasks.forEach(task => { const completedDate = task.completedAt.toDate(); if(dateFns.isAfter(completedDate, dateFns.subDays(now, 7))) { const formattedDay = dateFns.format(completedDate, 'dd/MM'); if(weeklyData[formattedDay] !== undefined) { weeklyData[formattedDay]++; } } });
            if(completedTasksChart) completedTasksChart.destroy();
            completedTasksChart = new Chart(document.getElementById('completed-tasks-chart'), { type: 'line', data: { labels: Object.keys(weeklyData), datasets: [{ label: 'Proyek Selesai', data: Object.values(weeklyData), borderColor: '#34D399', tension: 0.3, fill: true, backgroundColor: 'rgba(52, 211, 153, 0.1)' }] }, options: { scales: { y: { beginAtZero: true, ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { legend: { labels: { color: '#9CA3AF' } } } } });
            const clientData = {};
            doneTasks.forEach(task => { clientData[task.clientName] = (clientData[task.clientName] || 0) + 1; });
            if(artistDistributionChart) artistDistributionChart.destroy();
            artistDistributionChart = new Chart(document.getElementById('artist-distribution-chart'), { type: 'doughnut', data: { labels: Object.keys(clientData), datasets: [{ label: 'Proyek per Klien', data: Object.values(clientData), backgroundColor: ['#6366F1', '#F59E0B', '#10B981', '#EF4444', '#8B5CF6', '#3B82F6'] }] }, options: { plugins: { legend: { position: 'top', labels: { color: '#9CA3AF' } } } } });
        }
        function setupTimer() {
            const timerDisplay = document.getElementById('timer-display');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const timerProgress = document.getElementById('timer-progress');
            const pauseTimerBtn = document.getElementById('pause-timer-btn');
            const resetTimerBtn = document.getElementById('reset-timer-btn');
            const okTimerAlertBtn = document.getElementById('ok-timer-alert-btn');
            const timerAlertModal = document.getElementById('timer-alert-modal');
            let timerInterval = null;
            const FOCUS_TIME = 30 * 60;
            let remainingSeconds = FOCUS_TIME;
            let isTimerRunning = false;
            const updateTimerDisplay = () => { const minutes = Math.floor(remainingSeconds / 60); const seconds = remainingSeconds % 60; const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; timerDisplay.textContent = timeString; document.title = isTimerRunning ? `${timeString} - FocusCut` : 'FocusCut'; };
            const updateProgressBar = () => { if(timerProgress) timerProgress.style.width = `${(remainingSeconds / FOCUS_TIME) * 100}%`; };
            const startTimer = () => { if (isTimerRunning) return; isTimerRunning = true; startTimerBtn.classList.add('hidden'); pauseTimerBtn.classList.remove('hidden'); timerInterval = setInterval(() => { remainingSeconds--; updateTimerDisplay(); updateProgressBar(); if (remainingSeconds <= 0) { clearInterval(timerInterval); isTimerRunning = false; openModal(timerAlertModal); resetTimer(); } }, 1000); };
            const pauseTimer = () => { isTimerRunning = false; clearInterval(timerInterval); startTimerBtn.classList.remove('hidden'); pauseTimerBtn.classList.add('hidden'); updateTimerDisplay(); };
            const resetTimer = () => { pauseTimer(); remainingSeconds = FOCUS_TIME; updateTimerDisplay(); updateProgressBar(); };
            startTimerBtn.addEventListener('click', startTimer);
            pauseTimerBtn.addEventListener('click', pauseTimer);
            resetTimerBtn.addEventListener('click', resetTimer);
            okTimerAlertBtn.addEventListener('click', () => closeModal(timerAlertModal));
            updateTimerDisplay();
        };
        function setupProfilePicUpload(user, profileData) {
            const profilePicInput = document.getElementById('profile-pic-input');
            const profilePicLoader = document.getElementById('profile-pic-loader');
            const profilePic = document.getElementById('profile-pic');
            profilePicInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                profilePicLoader.classList.remove('hidden');
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result;
                    db.collection('whitelisted_users').doc(user.email).update({ photoURL: base64String })
                    .then(() => {
                        profilePic.src = base64String;
                        profileData.photoURL = base64String;
                        profilePicLoader.classList.add('hidden');
                    }).catch(error => {
                        profilePicLoader.classList.add('hidden');
                        console.error("Gagal update foto:", error);
                    });
                };
                reader.readAsDataURL(file);
            });
        }
        function setupBgUpload(user) {
            const bgUploadInput = document.getElementById('bg-upload-input');
            bgUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const backgroundURL = event.target.result;
                    document.body.style.backgroundImage = `url(${backgroundURL})`;
                    db.collection('whitelisted_users').doc(user.email).update({ backgroundURL: backgroundURL });
                };
                reader.readAsDataURL(file);
            });
        }
        function setupModals(user) {
            const taskModal = document.getElementById('task-modal');
            const assetModal = document.getElementById('asset-modal');
            const taskForm = document.getElementById('task-form');
            const assetForm = document.getElementById('asset-form');
            document.getElementById('add-task-btn').addEventListener('click', () => openModal(taskModal));
            document.getElementById('add-asset-btn').addEventListener('click', () => openModal(assetModal));
            document.getElementById('cancel-task-btn').addEventListener('click', () => closeModal(taskModal));
            document.getElementById('cancel-asset-btn').addEventListener('click', () => closeModal(assetModal));
            taskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const taskData = { clientName: document.getElementById('task-client-name').value, projectType: document.getElementById('task-project-type').value, priority: document.getElementById('task-priority').value, deadline: document.getElementById('task-deadline').value, contact: document.getElementById('task-contact').value, brief: document.getElementById('brief').value, status: 'todo', ownerId: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                db.collection('tasks').add(taskData).then(() => { taskForm.reset(); closeModal(taskModal); }).catch(error => console.error("Error menyimpan proyek:", error));
            });
            assetForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const assetData = { fileLink: document.getElementById('asset-file-link').value, clientName: document.getElementById('asset-client-name').value, projectType: document.getElementById('asset-project-type').value, shootDate: document.getElementById('asset-shoot-date').value, assetType: document.getElementById('asset-type').value, tags: document.getElementById('asset-tags').value.split(',').map(tag => tag.trim()), ownerId: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                db.collection('assets').add(assetData).then(() => { assetForm.reset(); closeModal(assetModal); }).catch(error => console.error("Error menyimpan aset:", error));
            });
        }
        function setupNavigation() {
            const navButtons = document.querySelectorAll('nav .nav-btn');
            const mainViews = document.querySelectorAll('.main-view');
            const mainActions = { 'kanban-view': document.getElementById('add-task-btn'), 'assets-view': document.getElementById('add-asset-btn'), };
            function handleNavigation(targetViewId) {
                mainViews.forEach(view => view.classList.add('hidden'));
                document.getElementById(targetViewId).classList.remove('hidden');
                navButtons.forEach(btn => { btn.classList.toggle('nav-btn-active', btn.dataset.view === targetViewId); });
                Object.values(mainActions).forEach(btn => btn && btn.classList.add('hidden'));
                if (mainActions[targetViewId]) { mainActions[targetViewId].classList.remove('hidden'); }
            }
            navButtons.forEach(button => { button.addEventListener('click', () => handleNavigation(button.dataset.view)); });
            handleNavigation('kanban-view');
        }
    });
    </script>
</body>
</html>
